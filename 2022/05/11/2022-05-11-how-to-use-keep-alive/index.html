<!DOCTYPE html>


  <html class="light page-post">


<head>
  <meta charset="utf-8">
  
  <title>看keep-alive如何在项目中失效 | mileOfSunshine</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="Vue3," />
  

  <meta name="description" content="keep-alive 是vue内置的一个组件，其作用是缓存不活动的组件。众所周知，一般在组件进行切换时，默认会进行销毁。若想在组件切换时保存原有的状态，那就需要利用 keep-alive 来实现。 keep-alive 的用法也不复杂，官网也做了说明，并给了示例。但有时规规矩矩的用了就是不生效。相信大家也会有这样的烦恼，接下来小编就列举下容易造成 keep-alive 失效的几个点。 案例 关键">
<meta property="og:type" content="article">
<meta property="og:title" content="看keep-alive如何在项目中失效">
<meta property="og:url" content="http://example.com/2022/05/11/2022-05-11-how-to-use-keep-alive/index.html">
<meta property="og:site_name" content="mileOfSunshine">
<meta property="og:description" content="keep-alive 是vue内置的一个组件，其作用是缓存不活动的组件。众所周知，一般在组件进行切换时，默认会进行销毁。若想在组件切换时保存原有的状态，那就需要利用 keep-alive 来实现。 keep-alive 的用法也不复杂，官网也做了说明，并给了示例。但有时规规矩矩的用了就是不生效。相信大家也会有这样的烦恼，接下来小编就列举下容易造成 keep-alive 失效的几个点。 案例 关键">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://p4.ssl.qhimg.com/t012fd27e9ca230afe2.jpg">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/901a1218ecb048939212f5a939a3ec16~tplv-k3u1fbpfcp-watermark.image">
<meta property="og:image" content="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/01308958f9bf4fb79664636ff9f34a77~tplv-k3u1fbpfcp-watermark.image">
<meta property="article:published_time" content="2022-05-11T00:00:00.000Z">
<meta property="article:modified_time" content="2022-05-19T07:45:20.664Z">
<meta property="article:author" content="mileOfSunshine">
<meta property="article:tag" content="Vue3">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://p4.ssl.qhimg.com/t012fd27e9ca230afe2.jpg">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=c114cbeddx" rel="stylesheet">


  
    
<link rel="stylesheet" href="/css/personal-style.css">

  

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-38189205-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?57e94d016e201fba3603a8a2b0263af0";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  
  <script type="text/javascript">
	(function(){
	    var bp = document.createElement('script');
	    var curProtocol = window.location.protocol.split(':')[0];
	    if (curProtocol === 'https') {
	        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
	    }
	    else {
	        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
	    }
	    var s = document.getElementsByTagName("script")[0];
	    s.parentNode.insertBefore(bp, s);
	})();
  </script>



  

<meta name="generator" content="Hexo 5.2.0"></head>

<body>


  
    <span id="toolbox-mobile" class="toolbox-mobile">盒子</span>
  

  <div class="post-header CENTER">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">盒子</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/archives/"
            rel="noopener noreferrer"
            target="_self"
            >
            博客
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/category/"
            rel="noopener noreferrer"
            target="_self"
            >
            分类
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/tag/"
            rel="noopener noreferrer"
            target="_self"
            >
            标签
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/about/"
            rel="noopener noreferrer"
            target="_self"
            >
            关于
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="CIRCLE"
            href="/search/"
            rel="noopener noreferrer"
            target="_self"
            >
            搜索
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B"><span class="toc-text">案例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93"><span class="toc-text">小结</span></a></li></ol>
  </div>



<div class="content content-post CENTER">
   <article id="post-2022-05-11-how-to-use-keep-alive" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">看keep-alive如何在项目中失效</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2022.05.11</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>mileOfSunshine</span>
        </span>
      

      
  <span class="article-category">
    <i class="icon-list"></i>
    <a class="article-category-link" href="/categories/%E5%89%8D%E7%AB%AF/">前端</a>
  </span>



      

      
      
    </div>
  </header>

  <div class="article-content">
    
      <p><img src="https://p4.ssl.qhimg.com/t012fd27e9ca230afe2.jpg" alt="banner"></p>
<p>keep-alive 是vue内置的一个组件，其作用是缓存不活动的组件。众所周知，一般在组件进行切换时，默认会进行销毁。若想在组件切换时保存原有的状态，那就需要利用 keep-alive 来实现。</p>
<p>keep-alive 的用法也不复杂，<a target="_blank" rel="noopener" href="https://v3.cn.vuejs.org/api/built-in-components.html#keep-alive">官网</a>也做了说明，并给了示例。但有时规规矩矩的用了就是不生效。相信大家也会有这样的烦恼，接下来小编就列举下容易造成 keep-alive 失效的几个点。</p>
<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><ol>
<li>关键词没拿捏好，一行注释都能让你忙活一上午。</li>
</ol>
<p><code>&lt;keep-alive&gt;</code> 是用在其<strong>一个直属</strong>的子组件被切换的情形。“<strong>一个</strong>”、“<strong>直属</strong>”这两点很好理解，却容易被忽视。有时为了提高代码可读性，我们会做个注释。而这个注释位置要是不对，违反了“<strong>一个</strong>”原则，就能造成 <code>keep-alive</code> 失效。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--掉坑，失效--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">keep-alive</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!-- 注释也会是keep-alive失效，删除本条注释功能正常 --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">component</span> <span class="attr">:is</span>=<span class="string">&quot;view&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">component</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">keep-alive</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>关于“<strong>直属</strong>”，或许你能拍胸脯告诉我你不可能因为这点翻车。我承认在刚开始开发项目时，开发者都头脑清晰，加上有官方文档的辅助能很好的规避掉错误点。但随着项目战线拉长，快速的需求变更迭代，难保你在实现功能过程中会不小心掉入了“<strong>直属</strong>”的坑中。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--掉坑，失效--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">keep-alive</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;margin: 10px;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">component</span> <span class="attr">:is</span>=<span class="string">&quot;view&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">component</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">keep-alive</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li><code>&lt;keep-alive&gt;</code> 直属子组件中使用了 <code>v-for</code>。</li>
</ol>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--失效--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">keep-alive</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">v-for</span>=<span class="string">&quot;tab in tabs&quot;</span> <span class="attr">:key</span>=<span class="string">&quot;tab&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">component</span> <span class="attr">:is</span>=<span class="string">&quot;`theme$&#123;tab&#125;`&quot;</span> <span class="attr">v-if</span>=<span class="string">&quot;tab === curTab&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">keep-alive</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--正常--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">keep-alive</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">component</span> <span class="attr">:is</span>=<span class="string">&quot;`theme$&#123;curTab&#125;`&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">keep-alive</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>你给我的，却不是我想要的。</li>
</ol>
<p>这里就涉及到 keep-alive 的俩 prop（<code>include</code> 和 <code>exclude</code>）。简单介绍下这俩 prop 的类型：</p>
<blockquote>
<ul>
<li>  <code>include</code> - <code>string | RegExp | Array</code>。只有名称匹配的组件会被缓存。</li>
<li>  <code>exclude</code> - <code>string | RegExp | Array</code>。任何名称匹配的组件都不会被缓存。</li>
</ul>
</blockquote>
<p>『你给我的，却不是我想要的』大概有这三种情形：</p>
<ul>
<li><code>include</code>（<code>exclude</code>）设置正确，使用了动态组件但并未在页面中引入相关组件；</li>
<li>找错对象了，易发在 <code>keep-alive</code> 结合 <code>router-view</code> 使用的场景，使用了 <code>vue-router</code>的 name 属性来设置<code>include</code>（<code>exclude</code>）；</li>
<li><code>include</code>（<code>exclude</code>）给的值与组件自身的 <code>name</code> 或是局部注册名称不匹配，定义时是小驼峰写法，使用时是大驼峰写法；</li>
</ul>
<p>这三点中最容易犯错的就是第二点，所以重要的事情要强调下。</p>
<blockquote>
<p>vue-router 的 name 属性是用于路由跳转!!!</p>
</blockquote>
<ol start="4">
<li>用逗号分隔字符串来表示 <code>include</code> 和 <code>exclude</code>时，因多余空格导致失效。</li>
</ol>
<p>为防止这种错误发生，推荐使用另外两种方式表示。正则表达式或一个数组。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">&lt;!--逗号分隔字符串 失效--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">keep-alive</span> <span class="attr">include</span>=<span class="string">&quot;Home, About&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">component</span> <span class="attr">:is</span>=<span class="string">&quot;view&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">component</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">keep-alive</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--逗号分隔字符串 正常--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">keep-alive</span> <span class="attr">include</span>=<span class="string">&quot;Home,About&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">component</span> <span class="attr">:is</span>=<span class="string">&quot;view&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">component</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">keep-alive</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 使用正则表达式 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">keep-alive</span> <span class="attr">:include</span>=<span class="string">&quot;/Home|About/&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">component</span> <span class="attr">:is</span>=<span class="string">&quot;view&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">component</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">keep-alive</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 使用数组 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">keep-alive</span> <span class="attr">:include</span>=<span class="string">&quot;[&#x27;Home&#x27;, &#x27;About&#x27;]&quot;</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">component</span> <span class="attr">:is</span>=<span class="string">&quot;view&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">component</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">keep-alive</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ol start="5">
<li>在 <code>Vue3</code> 中局部注册匿名组件后，缓存失效。</li>
</ol>
<blockquote>
<p><code>include</code> 和 <code>exclude</code> 匹配首先检查组件自身的 name 选项，如果 name 选项不可用，则匹配它的局部注册名称 (父组件 components 选项的键值)。</p>
</blockquote>
<p>按照官方文档的意思，只有组件自身 name 不可用（我的理解是就未指定 name），才匹配它的局部注册名称。这里我在Vue2 和 Vue3都做了试验，发现两者表现不同。</p>
<p>Vue2写法：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">&quot;switchTheme&quot;</span>&gt;</span>切换主题<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h4</span>&gt;</span>直属的子组件切换，子组件被缓存<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">keep-alive</span> <span class="attr">:include</span>=<span class="string">&quot;[&#x27;a1&#x27;, &#x27;a2&#x27;]&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">component</span> <span class="attr">:is</span>=<span class="string">&quot;`a$&#123;curTab&#125;`&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">keep-alive</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">const</span> Theme1 = &#123;</span></span><br><span class="line"><span class="javascript">  <span class="comment">// name: &#x27;Theme1&#x27;,</span></span></span><br><span class="line"><span class="handlebars"><span class="xml">  template: `<span class="tag">&lt;<span class="name">div</span>&gt;</span>主题1【</span><span class="template-variable">&#123;&#123; <span class="name">date</span> &#125;&#125;</span><span class="xml">】<span class="tag">&lt;/<span class="name">div</span>&gt;</span>`,</span></span></span><br><span class="line"><span class="javascript">  <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">      date: <span class="keyword">new</span> <span class="built_in">Date</span>()</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="javascript"><span class="keyword">const</span> Theme2 = &#123;</span></span><br><span class="line"><span class="javascript">  <span class="comment">// name: &#x27;Theme2&#x27;,</span></span></span><br><span class="line"><span class="handlebars"><span class="xml">  template: `<span class="tag">&lt;<span class="name">div</span>&gt;</span>主题2【</span><span class="template-variable">&#123;&#123; <span class="name">date</span> &#125;&#125;</span><span class="xml">】<span class="tag">&lt;/<span class="name">div</span>&gt;</span>`,</span></span></span><br><span class="line"><span class="javascript">  <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">      date: <span class="keyword">new</span> <span class="built_in">Date</span>()</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="javascript">  components: &#123; <span class="string">&#x27;a1&#x27;</span>: Theme1, <span class="string">&#x27;a2&#x27;</span>: Theme2 &#125;,</span></span><br><span class="line"><span class="javascript">  <span class="function"><span class="title">data</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line">      curTab: 2,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  methods: &#123;</span><br><span class="line"><span class="javascript">    switchTheme: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">      <span class="built_in">this</span>.curTab += <span class="number">1</span></span></span><br><span class="line"><span class="javascript">      <span class="keyword">if</span> (<span class="built_in">this</span>.curTab &gt; <span class="number">2</span>) &#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">this</span>.curTab = <span class="number">1</span></span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/901a1218ecb048939212f5a939a3ec16~tplv-k3u1fbpfcp-watermark.image" alt="Video_2022-05-13_150716.gif"></p>
<p><a target="_blank" rel="noopener" href="https://codepen.io/mileofsunshine/pen/jOZMQBr">点击查看效果</a></p>
<p>Vue3写法，相同部分的代码已省略</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--同上--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="keyword">const</span> Theme1 = &#123;&#125; <span class="comment">// 同上</span></span></span><br><span class="line"><span class="javascript"><span class="keyword">const</span> Theme2 = &#123;&#125; <span class="comment">// 同上</span></span></span><br><span class="line"></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line"><span class="javascript">  components: &#123; <span class="string">&#x27;a1&#x27;</span>: Theme1, <span class="string">&#x27;a2&#x27;</span>: Theme2 &#125;,</span></span><br><span class="line"><span class="javascript">  <span class="function"><span class="title">setup</span>(<span class="params"></span>)</span> &#123;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> curTab = ref(<span class="number">2</span>)</span></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> switchTheme = <span class="function">() =&gt;</span> &#123;</span></span><br><span class="line">      curTab.value += 1</span><br><span class="line">      if (curTab.value &gt; 2) &#123;</span><br><span class="line">        curTab.value = 1</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="javascript">    <span class="keyword">return</span> &#123;</span></span><br><span class="line">      curTab,</span><br><span class="line">      switchTheme</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/01308958f9bf4fb79664636ff9f34a77~tplv-k3u1fbpfcp-watermark.image" alt="2.gif"></p>
<p><a target="_blank" rel="noopener" href="https://codesandbox.io/s/vue3xia-de-keep-alivezhi-includeshi-li-iwocbh?file=/src/App.vue">点击查看效果</a></p>
<p>通过对比我们可以发现除了因 Vue 版本造成的写法不同外，二者并无差异。但运行后表现出在 Vue2 中<code>keep-alive</code> 功能正常，在 Vue3 中却失效。要是你的项目是用 Vue3 开发的，你就老老实实的给组件指定 name 吧。</p>
<ol start="6">
<li>匿名组件造成 <code>keep-alive</code> 失效。</li>
</ol>
<p>匿名组件就是未指定 name 的组件，但你要是通过局部（全局）组件注册后，它就是具名组件了。项目中容易出现匿名组件的就是Vue页面，<code>keep-alive</code> 结合 <code>router-view</code> 使用就容易让你困在vue-router 的 name 属性中，切记这个 name 属性只用于路由跳转。</p>
<p>vue2写法：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">keep-alive</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">router-view</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">keep-alive</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>vue3写法：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">router-view</span> <span class="attr">v-slot</span>=<span class="string">&quot;&#123; Component &#125;&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">transition</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">keep-alive</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">component</span> <span class="attr">:is</span>=<span class="string">&quot;Component&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">keep-alive</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">transition</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">router-view</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ol start="7">
<li>多级路由导致缓存失效</li>
</ol>
<p>多级路由一般出现在功能繁杂的后台管理系统中，为提高系统性能和改善用户体验，产品可能会要求对页面进行缓存以达到快速地在页面间来回切换。keep-alive 进而在管理系统中崭露头角，但其表现极其不稳定，着实让人摸不着头脑。</p>
<p>Layout.vue</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">router-view</span> <span class="attr">v-slot</span>=<span class="string">&quot;&#123; Component &#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">transition</span> <span class="attr">mode</span>=<span class="string">&quot;out-in&quot;</span> <span class="attr">name</span>=<span class="string">&quot;fade-transform&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">keep-alive</span> <span class="attr">:include</span>=<span class="string">&quot;[&#x27;theme1&#x27;, &#x27;theme2&#x27;]&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">component</span> <span class="attr">:is</span>=<span class="string">&quot;Component&quot;</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">keep-alive</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">transition</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">router-view</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>NestRouterView.vue</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">router-view</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>router.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    path: <span class="string">&#x27;/&#x27;</span>,</span><br><span class="line">    component: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;@/views/Layout.vue&#x27;</span>),</span><br><span class="line">    children: [</span><br><span class="line">      &#123;</span><br><span class="line">        name: <span class="string">&#x27;theme&#x27;</span>,</span><br><span class="line">        path: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        component: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;@/views/NestRouterView.vue&#x27;</span>),</span><br><span class="line">        children: [</span><br><span class="line">          &#123;</span><br><span class="line">            name: <span class="string">&#x27;theme1&#x27;</span>,</span><br><span class="line">            path: <span class="string">&#x27;theme/1&#x27;</span>,</span><br><span class="line">            component: <span class="function">() =&gt;</span> <span class="keyword">import</span>(<span class="string">&#x27;@/views/Theme1.vue&#x27;</span>),</span><br><span class="line">            meta: &#123;</span><br><span class="line">              title: <span class="string">&#x27;主题1&#x27;</span>,</span><br><span class="line">              keepAlive: <span class="literal">true</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>这里多级路由缓存失效的原因是借助了『空组件』（NestRouterView.vue）。关于缓存的设置也仅限生效于二级路由中，三级路由中并未涉及到 keep-alive，也就无从谈及失效一说。如何解决多级路由缓存失效问题，请移步小编的另一篇文章<a target="_blank" rel="noopener" href="https://mileofsunshine.github.io/2022/05/19/2022-05-19-keep-alive/">vue多级路由缓存(keep-alive)失效的解决方案</a>。</p>
<ol start="8">
<li><code>&lt;keep-alive&gt;</code> 不会在函数式组件中正常工作，因为它们没有缓存实例。</li>
</ol>
<p>函数式组件只是函数，无状态 (没有<a target="_blank" rel="noopener" href="https://cn.vuejs.org/v2/api/#%E9%80%89%E9%A1%B9-%E6%95%B0%E6%8D%AE">响应式数据</a>)，也无实例 (在vue2中，没有 <code>this</code> 上下文)。</p>
<p>以上是目前小编所知的8种失效场景。只有规避掉失效点，才能真正用好 <code>keep-alive</code>。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><ul>
<li><code>include</code> 和 <code>exclude</code> 推荐使用正则表达式或一个数组来表示；</li>
<li>需要缓存的组件都写 <code>name</code> 属性，杜绝匿名组件；</li>
<li>认清 <code>keep-alive</code> 和 <code>vue-router</code>的关系，杜绝乱用 <code>name</code>；</li>
<li>面对多层 <code>router-view</code> 嵌套，找准 <code>keep-alive</code> 位置；</li>
</ul>
<blockquote>
<p>本文作者： mileOfSunshine<br>本文链接： <a target="_blank" rel="noopener" href="https://mileofsunshine.github.io/2022/05/11/2022-05-11-how-to-use-keep-alive/">https://mileofsunshine.github.io/2022/05/11/2022-05-11-how-to-use-keep-alive/</a><br>版权声明：文章是原创作品。转载请注明出处！</p>
</blockquote>

    
  </div>

</article>


   

   
  <div class="box-prev-next clearfix">
    <a class="show pull-left" href="/2021/03/26/2021-03-26-about-sourcegraph/">
        <i class="icon icon-angle-left"></i>
    </a>
    <a class="show pull-right" href="/2022/05/19/2022-05-19-keep-alive/">
        <i class="icon icon-angle-right"></i>
    </a>
  </div>




</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">关闭</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/archives/"
              rel="noopener noreferrer"
              target="_self"
              >
              博客
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/category/"
              rel="noopener noreferrer"
              target="_self"
              >
              分类
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/tag/"
              rel="noopener noreferrer"
              target="_self"
              >
              标签
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/about/"
              rel="noopener noreferrer"
              target="_self"
              >
              关于
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="CIRCLE"
              href="/search/"
              rel="noopener noreferrer"
              target="_self"
              >
              搜索
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    

    
    

    

    
    

    

  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>

</body>
</html>
